!function(a,e){"use strict";var t,i,o="vis3",s=e.v.visualisations[o]=Object.create(e.v.visP);function n(a,t,i,s){t.on("remove",function(){a.closest(".pq-td-div").css("padding",""),a.closest("td").css("background-color",""),i.fadeIn(),e.d.oTaxa[s.taxon.kbValue].visState[o].imgDiv=null,t.is(".userRemoved")&&(e.d.oTaxa[s.taxon.kbValue].visState[o].displayImages=!1)})}function r(i){var s=i.attr("taxon"),r=e.d.oTaxa[s],d=a("<div>");e.f.addTaxonImagesToContainer({taxon:s,container:d,indexSelected:e.d.oTaxa[s].visState[o].indexSelected,imageRemovalButton:!0,height:t.vis3ColWidth,fImageSelect:function(a){e.d.oTaxa[s].visState[o].indexSelected=a}}),e.d.oTaxa[s].visState[o].imgDiv=d,i.closest(".pq-td-div").css("padding",0),i.closest("td").css("background-color","lightgrey"),i.append(d);var c=i.find(".loadImgIcon");return c.fadeOut(0),n(i,d,c,r),e.d.oTaxa[s].visState[o].displayImages=!0,d}function d(a,t,i){var o=i.Character,s=null;if("key"==i.Status)if("n/a"==t[o].kbValue||"novalue"==t[o].kbValue||""==t[o].kbValue)"n/a"==a[o].kbValue||"novalue"==a[o].kbValue||""==a[o].kbValue||(s=-1);else if("n/a"==a[o].kbValue||"novalue"==a[o].kbValue||""==a[o].kbValue)s=-1;else if("numeric"==i.ValueType){i.maxVal,i.minVal;var n=e.f.score.numberVsRange(t[o].getRange().min,a[o].getRange(),i.Latitude),r=e.f.score.numberVsRange(t[o].getRange().max,a[o].getRange(),i.Latitude);s=(n[0]-n[1]+r[0]-r[1])/2}else if("ordinal"==i.ValueType||"ordinalcircular"==i.ValueType){var d,c=0,l=0;["male","female",""].forEach(function(s){t[o].getOrdinalRanges(s).forEach(function(t){d=e.f.score.ordinal(t,a[o].getOrdinalRanges(s),i.CharacterStateValues,i.Latitude,"ordinalcircular"==i.ValueType),l+=d[0],l-=d[1],c++})}),s=l/c}else{c=0,l=0;["male","female",""].forEach(function(i){l+=e.f.score.jaccard(t[o].getStates(i),a[o].getStates(i)),c++}),s=2*(l/c)-1}return s}s.visName=o,s.initialise=function(){function s(a){var o=[];if(e.d.taxa.forEach(function(a){o.push(a)}),e.f.sortTaxa(o),o.length>a)var s=o.slice(0,a);else s=o;t.vis3Taxa=s.map(function(a){return a.taxon.kbValue}),i.deselectAllTaxa(),t.vis3Taxa.forEach(function(a){i.taxonClick(a)})}function n(o){var s=[];if(a("#visType3Grid").pqGrid("getColModel").forEach(function(a){"group"!=a.dataIndx&&"character"!=a.dataIndx&&s.push(e.d.oTaxa[a.dataIndx])}),0!=s.length){var n=s[0];if(o&&(s=e.d.taxa),s.forEach(function(a){a.taxon==n.taxon?a.vis3CompScore=999999:(a.vis3CompScore=0,e.d.characters.forEach(function(e){"key"==e.Status&&(a.vis3CompScore+=d(n,a,e))}))}),s.sort(function(a,e){return a.vis3CompScore>e.vis3CompScore?-1:1}),o)var r=s.slice(0,o+1);else r=s;t.vis3Taxa=r.map(function(a){return a.taxon.kbValue}),i.deselectAllTaxa(),t.vis3Taxa.forEach(function(a){i.taxonClick(a)})}}t=this,this.metadata.title="Side by side comparison",this.metadata.year="2018",this.metadata.authors="Burkmar, R",this.metadata.publisher="Field Studies Council",this.metadata.location="Shrewsbury, England",this.metadata.contact="r.burkmar@field-studies-council.org",this.metadata.version="1.8.0",this.imageIndex=0,this.helpFiles=[e.opts.tombiopath+"vis3/vis3Help.html",e.opts.tombiopath+"common/taxon-select-help.html"],e.gui.main.contextMenu.addItem("Get URL for side by side comparison view",function(){!function(){var s=[];s.push("selectedTool="+o);for(var n=[],r=a(".pq-grid-title-row").find(".pq-td-div"),d=1;d<r.length;d++)n.push(r[d].children[0].innerText);s.push("taxa="+n.join("^"));var c=[];n.forEach(function(a){void 0!==e.d.oTaxa[a].visState[o].indexSelected?c.push(e.d.oTaxa[a].visState[o].indexSelected):c.push("x")}),s.push("imgs="+c.join("-")),s.push("colwidth="+t.vis3ColWidth),s=i.setParamsFromState(s),e.f.createViewURL(s)}()},!1,[this.visName]),e.gui.main.contextMenu.addItem("Rank those shown against first",function(){n(),t.refresh()},!1,[this.visName]),e.gui.main.contextMenu.addItem("Show closest two to first",function(){n(2),t.refresh()},!1,[this.visName]),e.gui.main.contextMenu.addItem("Show closest five to first",function(){n(5),t.refresh()},!1,[this.visName]),e.gui.main.contextMenu.addItem("Show closest ten to first",function(){n(10),t.refresh()},!1,[this.visName]),e.gui.main.contextMenu.addItem("Show top two from key",function(){s(2),t.refresh()},!1,[this.visName]),e.gui.main.contextMenu.addItem("Show top five from key",function(){s(5),t.refresh()},!1,[this.visName]),e.gui.main.contextMenu.addItem("Show top ten from key",function(){s(10),t.refresh()},!1,[this.visName]),e.gui.main.contextMenu.addItem("Remove all",function(){t.vis3Taxa=[],t.refresh(),i.deselectAllTaxa()},!1,[this.visName]),t.vis3Taxa=[];var r=a("<div/>").css("position","relative").css("top",-13);a(this.cssSel).append(r),(i=Object.create(e.gui.taxonSelect)).init(e.gui.main.divInput,!0,function(a){a.selected&&-1==t.vis3Taxa.indexOf(a.selected)&&(t.vis3Taxa.push(a.selected),t.refresh()),a.deselected&&-1!=t.vis3Taxa.indexOf(a.deselected)&&(t.vis3Taxa.splice(t.vis3Taxa.indexOf(a.deselected),1),t.refresh()),0==a.taxa.length&&(t.vis3Taxa=[],t.refresh())}),r.append(a("<div>").css("display","inline-block").css("width",150).css("height",1));var c=a("<div id='visType3Grid'></div>");r.append(c),this.taxonSelect=i,this.initialised=!0,e.f.checkInterface(o,e.templates.visTemplate,e.v.visualisations[o])},s.refresh=function(){a("#visType3Grid").is(":empty")||a("#visType3Grid").pqGrid("destroy");var i=[],s={group:" Images",character:"Images"};this.vis3Taxa.forEach(function(t){var i=e.d.oTaxa[t],o=a("<div>").attr("taxon",t).css("position","relative").attr("class","vis3ImageDiv");s[i.taxon]=o[0].outerHTML}),i.push(s),e.d.characters.forEach(function(a){if("display"==a.Status||"key"==a.Status&&"Sex"!=a.Character){var o={group:a.Group,character:a.Label,pq_cellcls:{character:a.Character}};t.vis3Taxa.forEach(function(t){var i=e.d.oTaxa[t];o[i.taxon]=i[a.Character].toHtml1()}),i.push(o)}});var c=[];["group"].concat(["character"].concat(this.vis3Taxa)).forEach(function(a,e){if(0==e)var i=!0;else i=!1;if(1==e)var o="Character";else o="<i>"+a+"</i>";if(t.vis3ColWidth||(t.vis3ColWidth=200),t.vis3CharColWidth||(t.vis3CharColWidth=200),1==e)var s=t.vis3CharColWidth;else s=t.vis3ColWidth;var n={title:o,hidden:i,width:s,dataType:"string",dataIndx:a,sortable:!1};c.push(n)});var l=null;"visible"==a("input[name=groupvisibility]:checked").val()&&(l={dataIndx:["group"],collapsed:[!0],title:["<b style='font-weight:bold;'>{0}</b>","{0}"],dir:["up","down"]});var u={flexHeight:!0,flexWidth:!0,showTop:!1,showBottom:!1,showTitle:!1,numberCell:{show:!1},stripeRows:!0,columnBorders:!0,showHeader:!0,editable:!1,resizable:!1,groupModel:l,selectionModel:{type:null,mode:null},columnResize:function(a,e){!function(a){if("character"==a.dataIndx)return void(t.vis3CharColWidth=a.newWidth);console.log(a.newWidth),t.vis3ColWidth=a.newWidth,h()}(e)},refresh:function(){!function(){a(".vis3ImageDiv").each(function(){var t=a(this),i=a(this).attr("taxon"),s=e.d.oTaxa[i];if(e.f.getTaxonImages(i).length>0){var d=a("<img>").attr("src",e.opts.tombiopath+"resources/camera.png").addClass("loadImgIcon").css("cursor","pointer").css("width",15).on("click",function(){var e=a(this),i=r(t);n(t,i,e,s)});a(this).append(d),e.d.oTaxa[i].visState[o].displayImages&&r(t)}});var t=d3.scaleLinear().domain([-1,0,1]).range(e.d.scoreColours),i=[];if(a("#visType3Grid").pqGrid("getColModel").forEach(function(a){"group"!=a.dataIndx&&"character"!=a.dataIndx&&i.push(a.dataIndx)}),i.length<2)return;i.forEach(function(e,t){a("td[pq-row-indx=0][pq-col-indx="+(t+2)+"]").css("background-color","rgb(100,100,100)").css("color","white")});for(var s=e.d.oTaxa[i[0]],c=1;c<i.length;c++){var l=e.d.oTaxa[i[c]];for(var u in e.d.oCharacters){var h=e.d.oCharacters[u],v=a("."+h.Character).closest("tr").attr("pq-row-indx");if(null!=v){if(1==c){var f=a("#visType3Grid").pqGrid("getCell",{rowIndx:v,dataIndx:i[0]});"key"==h.Status?"n/a"==s[u].kbValue||"novalue"==s[u].kbValue||""==s[u].kbValue||"?"==s[u].kbValue?f.css("background-color","white"):f.css("background-color",t(1)):"display"==h.Status&&f.css("background-color","lightgrey")}var p=a("#visType3Grid").pqGrid("getCell",{rowIndx:v,dataIndx:i[c]}),m=d(s,l,h);"display"==h.Status?p.css("background-color","lightgrey"):null==m?p.css("background-color","white"):p.css("background-color",t(m))}}}}()}};function h(){a("#visType3Grid").pqGrid("getColModel").forEach(function(a){"group"!=a.dataIndx&&"character"!=a.dataIndx&&(a.width=t.vis3ColWidth)}),a("#visType3Grid").pqGrid("refresh")}u.colModel=c,u.dataModel={data:i,location:"local"},a("#visType3Grid").pqGrid(u),h()},s.urlParams=function(s){t.vis3ColWidth=s.colwidth,s.taxa&&s.taxa.split("^").forEach(function(a){i.taxonClick(a.replace(/%20/g," "))}),s.imgs&&s.imgs.split("-").forEach(function(i,s){var d=t.vis3Taxa[s];if("x"!=i){e.d.oTaxa[d].visState[o].indexSelected=i;var c=a('.vis3ImageDiv[taxon="'+d+'"]'),l=c.find(".loadImgIcon");n(c,r(c),l,d)}}),setTimeout(function(){i.initStateFromParams(s)},100)},s.show=function(){a("#vis3").show(),i.$div.show()},s.hide=function(){a("#vis3").hide(),i.$div.hide()}}(jQuery,this.tombiovis);